<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Conta - Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💙</text></svg>">
  <script src="auth-helper.js" defer></script>
</head>
<body>
  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <button id="modoBtn" class="btn-toggle">🌙</button>
      </div>
    </div>
  </nav>
  <section class="section auth-section">
    <div class="container auth-grid">
      <div>
        <span class="badge badge-primary">✨ Nova conta</span>
        <h1 style="margin-top: 1rem;">Junte-se a transformacao</h1>
        <p class="subtitle">Cadastre-se como doador para apoiar causas que mudam vidas, ou como ONG para publicar campanhas e receber doacoes com transparencia total.</p>
        <div class="helper-card">
          <h3>Como funciona?</h3>
          <ul>
            <li>Preencha seus dados basicos e confirme o cadastro.</li>
            <li>Doadoras e doadores chegam direto na vitrine de ONGs ativas.</li>
            <li>ONGs sao redirecionadas ao painel para criar campanhas.</li>
          </ul>
        </div>
      </div>
      <div class="auth-card">
        <div class="tab-buttons" role="tablist">
          <button class="tab-button active" data-target="doador" type="button">Sou doador</button>
          <button class="tab-button" data-target="ong" type="button">Sou uma ONG</button>
        </div>
        <form id="formDoador" class="form tab-content active" autocomplete="off">
          <div class="form-group">
            <label for="nomeDoador">Nome completo</label>
            <input id="nomeDoador" name="nome" type="text" placeholder="Digite seu nome" required minlength="3">
            <span class="input-error" id="errorNomeDoador"></span>
          </div>
          <div class="form-group">
            <label for="emailDoador">E-mail</label>
            <input id="emailDoador" name="email" type="email" placeholder="nome@email.com" required>
            <span class="input-error" id="errorEmailDoador"></span>
          </div>
          <div class="form-group">
            <label for="senhaDoador">Senha</label>
            <input id="senhaDoador" name="senha" type="password" placeholder="Crie uma senha" required minlength="8">
            <div class="password-strength" id="strengthDoador">
              <div class="password-strength-bar">
                <div class="password-strength-fill" id="strengthFillDoador"></div>
              </div>
              <span class="password-strength-text" id="strengthTextDoador"></span>
            </div>
            <p class="input-hint">Use 8+ caracteres com maiúscula, minúscula, número e símbolo.</p>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-primary" id="btnCadastrarDoador">💚 Quero fazer a diferença</button>
          </div>
          <p class="form-feedback" id="feedbackDoador"></p>
        </form>
        <form id="formOng" class="form tab-content" autocomplete="off" hidden>
          <div class="form-group">
            <label for="nomeOng">Nome da ONG</label>
            <input id="nomeOng" name="nome" type="text" placeholder="Nome fantasia" required minlength="3">
            <span class="input-error" id="errorNomeOng"></span>
          </div>
          <div class="form-group">
            <label for="emailOng">E-mail institucional</label>
            <input id="emailOng" name="email" type="email" placeholder="contato@ong.org" required>
            <span class="input-error" id="errorEmailOng"></span>
          </div>
          <div class="form-group">
            <label for="senhaOng">Senha</label>
            <input id="senhaOng" name="senha" type="password" placeholder="Crie uma senha" required minlength="8">
            <div class="password-strength" id="strengthOng">
              <div class="password-strength-bar">
                <div class="password-strength-fill" id="strengthFillOng"></div>
              </div>
              <span class="password-strength-text" id="strengthTextOng"></span>
            </div>
            <p class="input-hint">Use 8+ caracteres com maiúscula, minúscula, número e símbolo.</p>
          </div>
          <div class="form-group">
            <label for="descricaoOng">Descrição</label>
            <textarea id="descricaoOng" name="descricao" placeholder="Explique sua causa em poucas palavras..." rows="3" required minlength="20"></textarea>
            <span class="input-hint" id="charCountOng">0/200 caracteres</span>
          </div>
          <div class="form-group">
            <label for="siteOng">Site ou rede social</label>
            <input id="siteOng" name="website" type="url" placeholder="https://" required>
            <span class="input-error" id="errorSiteOng"></span>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-primary" id="btnCadastrarOng">🚀 Criar minha conta</button>
          </div>
          <p class="form-feedback" id="feedbackOng"></p>
        </form>
        <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">Já tem conta? <a href="auth.html" style="color: var(--primary); font-weight: 600;">Faça login</a></p>
      </div>
    </div>
  </section>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // Redirecionar se já estiver logado
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");
    const ongId = localStorage.getItem("ongId");
    if (token && (userId || ongId)) {
      window.location.href = userId ? "perfil.html" : "painel.html";
    }

    // Sistema de tema
    const body = document.body;
    const btnModo = document.getElementById("modoBtn");
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      btnModo.textContent = "☀️";
    }
    btnModo.addEventListener("click", () => {
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      btnModo.textContent = dark ? "☀️" : "🌙";
    });

    // Sistema de abas
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");
    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        tabContents.forEach((content) => {
          content.classList.remove("active");
          content.hidden = true;
        });
        button.classList.add("active");
        const target = document.getElementById(`form${button.dataset.target.charAt(0).toUpperCase() + button.dataset.target.slice(1)}`);
        target.classList.add("active");
        target.hidden = false;
      });
    });

    // Validação de senha
    const SENHA_REGEX = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]).{8,}$/;
    
    function senhaValida(valor) {
      return SENHA_REGEX.test(valor || "");
    }

    // Indicador de força de senha
    function updatePasswordStrength(inputId, fillId, textId) {
      const input = document.getElementById(inputId);
      const fill = document.getElementById(fillId);
      const text = document.getElementById(textId);

      if (!input || !fill || !text) return;

      input.addEventListener('input', () => {
        const value = input.value;
        const strength = Validators.passwordStrength(value);
        
        fill.className = 'password-strength-fill ' + strength.level;
        text.className = 'password-strength-text ' + strength.level;
        text.textContent = strength.text;
      });
    }

    // Inicializar indicadores de força de senha
    updatePasswordStrength('senhaDoador', 'strengthFillDoador', 'strengthTextDoador');
    updatePasswordStrength('senhaOng', 'strengthFillOng', 'strengthTextOng');

    // Contador de caracteres para descrição da ONG
    const descricaoOng = document.getElementById('descricaoOng');
    const charCount = document.getElementById('charCountOng');
    if (descricaoOng && charCount) {
      descricaoOng.addEventListener('input', () => {
        const len = descricaoOng.value.length;
        charCount.textContent = `${len}/200 caracteres`;
        charCount.style.color = len > 200 ? 'var(--danger)' : 'var(--text-light)';
      });
    }

    // Validação em tempo real de email
    function validateEmailField(inputId, errorId) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);
      if (!input || !error) return;

      input.addEventListener('blur', () => {
        if (input.value && !Validators.email(input.value)) {
          error.textContent = 'Digite um e-mail válido';
          error.style.display = 'block';
          input.style.borderColor = 'var(--danger)';
        } else {
          error.textContent = '';
          error.style.display = 'none';
          input.style.borderColor = '';
        }
      });
    }

    validateEmailField('emailDoador', 'errorEmailDoador');
    validateEmailField('emailOng', 'errorEmailOng');

    // Handler de cadastro melhorado
    function handleCadastro({ form, endpoint, feedback, button, redirect, storageKeys }) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        feedback.textContent = "";
        feedback.style.color = "var(--text-secondary)";
        
        // Usar Loading do auth-helper
        Loading.button(button, true);
        
        const payload = Object.fromEntries(new FormData(form).entries());
        
        // Validações
        if (!senhaValida(payload.senha)) {
          Toast.error("Senha precisa ter 8+ caracteres, com maiúscula, minúscula, número e símbolo.");
          Loading.button(button, false);
          return;
        }

        if (!Validators.email(payload.email)) {
          Toast.error("Digite um e-mail válido.");
          Loading.button(button, false);
          return;
        }
        
        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data.error || "Não foi possível concluir o cadastro");
          }
          
          if (storageKeys) {
            Object.entries(storageKeys).forEach(([key, value]) => {
              localStorage.setItem(key, typeof value === "function" ? value(data) : value);
            });
          }
          
          // Salvar nome do usuário
          if (payload.nome) {
            localStorage.setItem('userName', payload.nome);
          }
          
          Toast.success("Cadastro concluído! Bem-vindo à Causa Digital! 🎉");
          
          setTimeout(() => {
            window.location.href = redirect;
          }, 1500);
        } catch (error) {
          Toast.error(error.message);
          feedback.textContent = error.message;
          feedback.style.color = "var(--danger)";
        } finally {
          Loading.button(button, false);
        }
      });
    }
    const formDoador = document.getElementById("formDoador");
    const formOng = document.getElementById("formOng");
    handleCadastro({
      form: formDoador,
      endpoint: "/api/doadores",
      feedback: document.getElementById("feedbackDoador"),
      button: document.getElementById("btnCadastrarDoador"),
      redirect: "perfil.html",
      storageKeys: {
        token: "demo-token",
        userId: (data) => data._id,
        userType: "doador"
      }
    });
    handleCadastro({
      form: formOng,
      endpoint: "/api/ongs",
      feedback: document.getElementById("feedbackOng"),
      button: document.getElementById("btnCadastrarOng"),
      redirect: "painel.html",
      storageKeys: {
        token: "demo-token",
        ongId: (data) => data._id,
        userType: "ong"
      }
    });
  </script>
</body>
</html>
