<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Conta ‚Äî Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíô</text></svg>">
</head>
<body>
  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <a href="auth.html" class="btn-secondary outline">Entrar</a>
        <a href="cadastro.html" class="btn-primary">Criar conta</a>
        <button id="modoBtn" class="btn-toggle">üåô</button>
      </div>
    </div>
  </nav>

  <section class="section auth-section">
    <div class="container auth-grid">
      <div>
        <span class="badge badge-primary">‚ú® Nova conta</span>
        <h1 style="margin-top: 1rem;">Junte-se √† transforma√ß√£o</h1>
        <p class="subtitle">Cadastre-se como doador para apoiar causas que mudam vidas, ou como ONG para publicar campanhas e receber doa√ß√µes com transpar√™ncia total.</p>
        <div class="helper-card">
          <h3>Como funciona?</h3>
          <ul>
            <li>Preencha seus dados b√°sicos e confirme o cadastro.</li>
            <li>Doadoras e doadores chegam direto na vitrine de ONGs ativas.</li>
            <li>ONGs s√£o redirecionadas ao painel para criar campanhas.</li>
          </ul>
        </div>
      </div>

      <div class="auth-card">
        <div class="tab-buttons" role="tablist">
          <button class="tab-button active" data-target="doador" type="button">Sou doador</button>
          <button class="tab-button" data-target="ong" type="button">Sou uma ONG</button>
        </div>

        <form id="formDoador" class="form tab-content active" autocomplete="off">
          <div class="form-group">
            <label for="nomeDoador">Nome completo</label>
            <input id="nomeDoador" name="nome" type="text" placeholder="Digite seu nome" required>
          </div>
          <div class="form-group">
            <label for="emailDoador">E-mail</label>
            <input id="emailDoador" name="email" type="email" placeholder="nome@email.com" required>
          </div>
          <div class="form-group">
            <label for="senhaDoador">Senha</label>
            <input id="senhaDoador" name="senha" type="password" placeholder="Crie uma senha" required>
            <p class="input-hint">Use 8+ caracteres com mai√∫scula, min√∫scula, n√∫mero e s√≠mbolo.</p>
          </div>
          <button type="submit" class="btn-primary" id="btnCadastrarDoador">‚ù§Ô∏è Quero fazer a diferen√ßa</button>
          <p class="form-feedback" id="feedbackDoador"></p>
        </form>

        <form id="formOng" class="form tab-content" autocomplete="off" hidden>
          <div class="form-group">
            <label for="nomeOng">Nome da ONG</label>
            <input id="nomeOng" name="nome" type="text" placeholder="Nome fantasia" required>
          </div>
          <div class="form-group">
            <label for="emailOng">E-mail institucional</label>
            <input id="emailOng" name="email" type="email" placeholder="contato@ong.org" required>
          </div>
          <div class="form-group">
            <label for="senhaOng">Senha</label>
            <input id="senhaOng" name="senha" type="password" placeholder="Crie uma senha" required>
            <p class="input-hint">Use 8+ caracteres com mai√∫scula, min√∫scula, n√∫mero e s√≠mbolo.</p>
          </div>
          <div class="form-group">
            <label for="descricaoOng">Descri√ß√£o</label>
            <textarea id="descricaoOng" name="descricao" placeholder="Explique sua causa" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="siteOng">Site ou rede social</label>
            <input id="siteOng" name="website" type="url" placeholder="https://" required>
          </div>
          <button type="submit" class="btn-primary" id="btnCadastrarOng">üöÄ Criar minha conta</button>
          <p class="form-feedback" id="feedbackOng"></p>
        </form>

        <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">J√° tem conta? <a href="auth.html">Fa√ßa login</a></p>
      </div>
    </div>
  </section>

  <script>
    const body = document.body;
    const btnModo = document.getElementById("modoBtn");
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      btnModo.textContent = "‚òÄÔ∏è";
    }
    btnModo.addEventListener("click", () => {
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      btnModo.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    });

    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");

    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        tabContents.forEach((content) => {
          content.classList.remove("active");
          content.hidden = true;
        });

        button.classList.add("active");
        const target = document.getElementById(`form${button.dataset.target.charAt(0).toUpperCase() + button.dataset.target.slice(1)}`);
        target.classList.add("active");
        target.hidden = false;
      });
    });

    const SENHA_REGEX = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]).{8,}$/;

    function senhaValida(valor) {
      return SENHA_REGEX.test(valor || "");
    }

    function handleCadastro({ form, endpoint, feedback, button, redirect, storageKeys }) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        feedback.textContent = "";
        feedback.style.color = "var(--text-secondary)";
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = "Enviando...";

        const payload = Object.fromEntries(new FormData(form).entries());
        if (!senhaValida(payload.senha)) {
          feedback.textContent = "Senha precisa ter 8+ caracteres, com mai√∫scula, min√∫scula, n√∫mero e s√≠mbolo.";
          feedback.style.color = "var(--danger, #d0342c)";
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "N√£o foi poss√≠vel concluir o cadastro");
          }

          if (storageKeys) {
            Object.entries(storageKeys).forEach(([key, value]) => {
              localStorage.setItem(key, typeof value === "function" ? value(data) : value);
            });
          }

          feedback.textContent = "Cadastro conclu√≠do! Redirecionando...";
          feedback.style.color = "var(--success, #1f9254)";
          setTimeout(() => {
            window.location.href = redirect;
          }, 600);
        } catch (error) {
          feedback.textContent = error.message;
          feedback.style.color = "var(--danger, #d0342c)";
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      });
    }

    const formDoador = document.getElementById("formDoador");
    const formOng = document.getElementById("formOng");

    handleCadastro({
      form: formDoador,
      endpoint: "/api/doadores",
      feedback: document.getElementById("feedbackDoador"),
      button: document.getElementById("btnCadastrarDoador"),
      redirect: "ongs.html",
      storageKeys: {
        userId: (data) => data._id,
        userType: "doador"
      }
    });

    handleCadastro({
      form: formOng,
      endpoint: "/api/ongs",
      feedback: document.getElementById("feedbackOng"),
      button: document.getElementById("btnCadastrarOng"),
      redirect: "painel.html",
      storageKeys: {
        ongId: (data) => data._id,
        userType: "ong"
      }
    });
  </script>
</body>
</html>
