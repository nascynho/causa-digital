<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💙</text></svg>">
  <script src="auth-helper.js" defer></script>
  <style>
    .creditos-card { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .creditos-info h3 { margin: 0 0 0.25rem; font-size: 0.9rem; opacity: 0.9; font-weight: 500; }
    .creditos-valor { font-size: 2rem; font-weight: 700; }
    .creditos-actions { display: flex; gap: 0.5rem; }
    .creditos-actions a { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 0.5rem 1rem; border-radius: var(--radius); text-decoration: none; font-size: 0.9rem; transition: all 0.2s; }
    .creditos-actions a:hover { background: rgba(255,255,255,0.3); }
  </style>
</head>
<body>
  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <button id="modoBtn" class="btn-toggle">🌙</button>
      </div>
    </div>
  </nav>
  <section class="section">
    <div class="container" style="max-width: 800px;">
      <div class="card" id="perfilInfo">
        <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
          <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem;" id="avatar">?</div>
          <div>
            <h1 style="margin: 0;" id="nomeUsuario">Carregando...</h1>
            <p style="color: var(--text-secondary); margin: 0.25rem 0 0;" id="emailUsuario">...</p>
          </div>
        </div>
        <div class="creditos-card">
          <div class="creditos-info">
            <h3>💰 Meus Creditos</h3>
            <div class="creditos-valor" id="creditosUsuario">0</div>
          </div>
          <div class="creditos-actions">
            <a href="creditos.html">+ Comprar</a>
            <a href="campanhas.html">💙 Doar</a>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-value" id="totalDoado">R$ 0</span>
            <span class="stat-label">Total Doado</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="pontos">0</span>
            <span class="stat-label">Pontos</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="nivel">1</span>
            <span class="stat-label">Nivel</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="doacoes">0</span>
            <span class="stat-label">Doacoes</span>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top: 1.5rem;">
        <h2 style="margin-bottom: 1rem;">🏆 Conquistas</h2>
        <div id="conquistas" class="badges-grid">
          <div class="badge-card locked">
            <span style="font-size: 2rem;">🌱</span>
            <span>Primeira Doacao</span>
          </div>
          <div class="badge-card locked">
            <span style="font-size: 2rem;">⭐</span>
            <span>5 Doacoes</span>
          </div>
          <div class="badge-card locked">
            <span style="font-size: 2rem;">💎</span>
            <span>R$ 500 doados</span>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top: 1.5rem;">
        <h2 style="margin-bottom: 1rem;">📋 Historico de Doacoes</h2>
        <div id="historico">
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Carregando...</p>
        </div>
      </div>
    </div>
  </section>
  <script>
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");
    if (!token || !userId) {
      window.location.href = "auth.html";
    }
    const body = document.body;
    const modoBtn = document.getElementById("modoBtn");
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      modoBtn.textContent = "☀️";
    }
    modoBtn.addEventListener("click", () => {
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      modoBtn.textContent = dark ? "☀️" : "🌙";
    });

    const mockPerfil = {
      nome: "Doador Demo",
      email: "doador@demo.com",
      pontos: 450,
      nivel: 2,
      creditos: 100,
      totalDoado: 350,
      doacoes: [
        { campanha: "Cesta Basica para 100 Familias", valor: 100, data: "2025-01-15" },
        { campanha: "Material Escolar Completo", valor: 150, data: "2025-01-10" },
        { campanha: "Medicamentos Essenciais", valor: 100, data: "2025-01-05" }
      ]
    };

    async function carregarPerfil() {
      try {
        const res = await fetch(`/api/doadores/${userId}`);
        let perfil = null;
        if (res.ok) {
          perfil = await res.json();
        }
        if (!perfil) perfil = mockPerfil;
        renderPerfil(perfil);
        carregarDoacoes();
      } catch (error) {
        renderPerfil(mockPerfil);
      }
    }

    async function carregarDoacoes() {
      try {
        const res = await fetch(`/api/doacoes/doador/${userId}`);
        if (res.ok) {
          const doacoes = await res.json();
          renderHistorico(doacoes);
        }
      } catch (error) {
        console.error("Erro ao carregar doacoes");
      }
    }

    function renderPerfil(perfil) {
      document.getElementById("avatar").textContent = perfil.nome.charAt(0).toUpperCase();
      document.getElementById("nomeUsuario").textContent = perfil.nome;
      document.getElementById("emailUsuario").textContent = perfil.email;
      document.getElementById("creditosUsuario").textContent = (perfil.creditos || 0).toLocaleString();
      document.getElementById("totalDoado").textContent = `R$ ${(perfil.totalArrecadado || perfil.totalDoado || 0).toLocaleString()}`;
      document.getElementById("pontos").textContent = (perfil.pontos || 0).toLocaleString();
      document.getElementById("nivel").textContent = perfil.nivel || 1;
      document.getElementById("doacoes").textContent = (perfil.doacoes || []).length;
      
      const conquistas = document.getElementById("conquistas");
      const badges = [];
      const badgesList = perfil.badges || [];
      
      if (badgesList.includes("impacto_inicial") || badgesList.includes("primeiro_passo")) {
        badges.push({ emoji: "🌱", nome: "Primeira Doacao" });
      }
      if (badgesList.includes("parceiro_constante")) {
        badges.push({ emoji: "⭐", nome: "5 Doacoes" });
      }
      if (badgesList.includes("heroi_solidario")) {
        badges.push({ emoji: "🦸", nome: "Heroi Solidario" });
      }
      if (badgesList.includes("benfeitor")) {
        badges.push({ emoji: "💎", nome: "Benfeitor" });
      }
      
      if (badges.length) {
        conquistas.innerHTML = badges.map(b => `
          <div class="badge-card">
            <span style="font-size: 2rem;">${b.emoji}</span>
            <span>${b.nome}</span>
          </div>
        `).join("");
      }
    }

    function renderHistorico(doacoes) {
      const historico = document.getElementById("historico");
      if (!doacoes.length) {
        historico.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Voce ainda nao fez nenhuma doacao. <a href="campanhas.html" style="color: var(--primary);">Comece agora!</a></p>`;
        return;
      }
      historico.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid var(--border-color);">
              <th style="text-align: left; padding: 0.75rem 0;">Campanha</th>
              <th style="text-align: right; padding: 0.75rem 0;">Valor</th>
              <th style="text-align: right; padding: 0.75rem 0;">Pontos</th>
              <th style="text-align: right; padding: 0.75rem 0;">Data</th>
            </tr>
          </thead>
          <tbody>
            ${doacoes.map(d => `
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 0.75rem 0;">${d.campanha?.titulo || d.campanha || "Campanha"}</td>
                <td style="text-align: right; padding: 0.75rem 0; color: var(--success);">R$ ${d.valor.toLocaleString()}</td>
                <td style="text-align: right; padding: 0.75rem 0; color: var(--primary);">+${d.pontosConcedidos || d.valor * 10}</td>
                <td style="text-align: right; padding: 0.75rem 0; color: var(--text-secondary);">${new Date(d.criadoEm || d.data).toLocaleDateString("pt-BR")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    carregarPerfil();
  </script>
</body>
</html>
