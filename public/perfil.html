<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil â€” Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’™</text></svg>">
</head>
<body>

  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <a href="auth.html" class="btn-secondary outline">Trocar conta</a>
        <button id="modoBtn" class="btn-toggle">ğŸŒ™</button>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="container">
      <h2>ğŸ‘¤ Meu Perfil de Doador</h2>

      <div class="helper-banner" id="nextActionBanner">
        <div>
          <strong>PrÃ³ximo passo recomendado</strong>
          <p id="nextActionText">Carregando seu impacto...</p>
        </div>
        <div style="margin-left: auto; display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <a href="campanhas.html" class="btn-primary">Doar agora</a>
          <a href="#metas" class="btn-secondary outline">Revisar metas</a>
        </div>
      </div>
      
      <!-- HEADER DO PERFIL -->
      <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%); color: white; padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 3rem; box-shadow: var(--shadow-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <div>
            <h3 id="userName" style="font-size: 1.8rem; margin-bottom: 0.5rem;">Carregando...</h3>
            <p id="userLevel" style="opacity: 0.9;">NÃ­vel 1</p>
          </div>
          <div style="font-size: 4rem;">ğŸ§‘â€ğŸ¤â€ğŸ§‘</div>
        </div>
        
        <!-- STATS PRINCIPAIS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
          <div>
            <p style="opacity: 0.9; margin-bottom: 0.5rem;">Pontos Acumulados</p>
            <h4 id="userPoints" style="font-size: 1.8rem; margin: 0;">0</h4>
          </div>
          <div>
            <p style="opacity: 0.9; margin-bottom: 0.5rem;">Total Arrecadado</p>
            <h4 id="userTotal" style="font-size: 1.8rem; margin: 0;">R$ 0</h4>
          </div>
          <div>
            <p style="opacity: 0.9; margin-bottom: 0.5rem;">DoaÃ§Ãµes</p>
            <h4 id="userDoacoes" style="font-size: 1.8rem; margin: 0;">0</h4>
          </div>
          <div>
            <p style="opacity: 0.9; margin-bottom: 0.5rem;">Badges</p>
            <h4 id="userBadges" style="font-size: 1.8rem; margin: 0;">0</h4>
          </div>
        </div>
      </div>

      <div class="card ranking-card">
        <div class="ranking-card__header">
          <div>
            <h3>Ranking geral</h3>
            <p class="subtitle">Seu posicionamento entre os maiores doadores da semana.</p>
          </div>
          <span class="badge badge-primary" id="rankingPosition">--</span>
        </div>
        <div id="rankingList" class="ranking-list">
          <p class="loading-message">Carregando ranking...</p>
        </div>
      </div>

      <!-- TABS -->
      <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--bg-secondary); flex-wrap: wrap;">
        <button class="tab-btn active" data-tab="conquistas" style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--accent); border-bottom: 3px solid var(--accent); font-size: 1rem;">ğŸ† Conquistas</button>
        <button class="tab-btn" data-tab="historico" style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; font-size: 1rem;">ğŸ“œ HistÃ³rico</button>
        <button class="tab-btn" data-tab="metas" style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; font-size: 1rem;">ğŸ¯ Metas</button>
      </div>

      <!-- CONQUISTAS -->
      <div id="conquistas" class="tab-content" style="display: block;">
        <h3 style="margin-bottom: 1.5rem;">Suas Conquistas</h3>
        <div id="badgesContainer" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <p class="loading-message" style="grid-column: 1 / -1;">Carregando conquistas...</p>
        </div>
      </div>

      <!-- HISTÃ“RICO -->
      <div id="historico" class="tab-content" style="display: none;">
        <h3 style="margin-bottom: 1.5rem;">ğŸ“œ HistÃ³rico de DoaÃ§Ãµes</h3>
        <div id="doacoesContainer" class="loading-message">Carregando histÃ³rico...</div>
      </div>

      <!-- METAS PESSOAIS -->
      <div id="metas" class="tab-content" style="display: none;">
        <h3 style="margin-bottom: 1.5rem;">Metas Pessoais de Impacto</h3>
        <div style="margin-bottom: 2rem;">
          <h4 style="margin-bottom: 1rem;">Criar uma Meta</h4>
          <form id="metasForm" class="form" style="max-width: 500px;">
            <input type="text" placeholder="Nome da meta (ex: AlimentaÃ§Ã£o)" required>
            <input type="number" placeholder="Valor desejado em R$" required>
            <select required>
              <option>AlimentaÃ§Ã£o</option>
              <option>SaÃºde</option>
              <option>EducaÃ§Ã£o</option>
              <option>Abrigo</option>
              <option>Outra</option>
            </select>
            <button type="submit" class="btn-primary">Criar Meta</button>
          </form>
        </div>
        <div id="metasContainer" class="grid">
          <p class="loading-message" style="grid-column: 1 / -1;">Carregando metas...</p>
        </div>
      </div>
    </div>
  </section>

  <footer style="padding: 3rem 0; border-top: 1px solid var(--border-color); margin-top: 2rem;">
    <div class="container" style="text-align: center;">
      <p style="color: var(--text-secondary);">ğŸ’™ Â© 2025 Causa Digital â€” Seu impacto importa</p>
    </div>
  </footer>

  <script>
    const body = document.body;
    const btn = document.getElementById("modoBtn");
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      btn.textContent = "â˜€ï¸";
    }
    btn.addEventListener("click", () => {
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      btn.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
    });

    // Simular ID de doador (em produÃ§Ã£o, viria de autenticaÃ§Ã£o)
    const userId = localStorage.getItem("userId") || "user123";

    const badgesInfo = {
      impacto_inicial: { nome: 'â­ Impacto Inicial', descricao: 'Sua primeira doaÃ§Ã£o registrada!', emoji: 'â­' },
      parceiro_constante: { nome: 'ğŸ¤ Parceiro Constante', descricao: 'VocÃª completou 5 doaÃ§Ãµes.', emoji: 'ğŸ¤' },
      lider_generoso: { nome: 'ğŸ‘‘ LÃ­der Generoso', descricao: '15 doaÃ§Ãµes feitas para causas diferentes.', emoji: 'ğŸ‘‘' },
      primeiro_passo: { nome: 'ğŸ‘£ Primeiro Passo', descricao: 'Primeira contribuiÃ§Ã£o confirmada!', emoji: 'ğŸ‘£' },
      heroi_solidario: { nome: 'ğŸ¦¸ HerÃ³i SolidÃ¡rio', descricao: 'Acumulou mais de 100 pontos.', emoji: 'ğŸ¦¸' },
      benfeitor: { nome: 'ğŸŒŸ Benfeitor', descricao: 'Ultrapassou 1.000 pontos somados!', emoji: 'ğŸŒŸ' }
    };

    async function carregarPerfil() {
      try {
        const res = await fetch(`/api/doadores/${userId}`);
        const doador = await res.json();

        document.getElementById("userName").textContent = doador.nome || "Doador AnÃ´nimo";
        document.getElementById("userLevel").textContent = `NÃ­vel ${doador.nivel}`;
        document.getElementById("userPoints").textContent = `${doador.pontos.toLocaleString()} pts`;
        document.getElementById("userTotal").textContent = `R$ ${doador.totalArrecadado.toLocaleString()}`;
        document.getElementById("userDoacoes").textContent = (doador.doacoes || []).length;
        document.getElementById("userBadges").textContent = (doador.badges || []).length;

        // Atualizar sugestÃ£o de prÃ³ximo passo
        const nextActionText = document.getElementById("nextActionText");
        if ((doador.doacoes || []).length === 0) {
          nextActionText.textContent = "VocÃª ainda nÃ£o realizou doaÃ§Ãµes. Escolha uma campanha para destravar sua primeira badge.";
        } else if ((doador.badges || []).length < 3) {
          nextActionText.textContent = "Continue doando para desbloquear novas conquistas e subir de nÃ­vel.";
        } else {
          nextActionText.textContent = "Excelente ritmo! Compartilhe sua trajetÃ³ria com amigos e inspire novos doadores.";
        }

        // Carregar badges
        const badgesContainer = document.getElementById("badgesContainer");
        if (doador.badges && doador.badges.length > 0) {
          badgesContainer.innerHTML = doador.badges.map(b => {
            const info = badgesInfo[b] || { nome: 'Conquista', descricao: 'Desbloqueada', emoji: 'ğŸŒŸ' };
            return `
              <div class="achievement-badge">
                <div class="achievement-icon" style="font-size: 2rem;">${info.emoji || 'ğŸŒŸ'}</div>
                <strong>${info.nome}</strong>
                <p style="font-size: 0.85rem; color: var(--text-secondary);">${info.descricao}</p>
              </div>
            `;
          }).join("");
        } else {
          badgesContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">Comece a doar para desbloquear conquistas.</p>';
        }

        // Carregar histÃ³rico de doaÃ§Ãµes
        const doacoesRes = await fetch(`/api/doacoes/doador/${userId}`);
        const doacoes = await doacoesRes.json();
        const doacoesContainer = document.getElementById("doacoesContainer");
        
        if (doacoes.length > 0) {
          doacoesContainer.innerHTML = doacoes.map(d => `
            <div class="card" style="margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <h4>${d.campanha.titulo}</h4>
                  <p style="color: var(--text-secondary); font-size: 0.9rem;">${new Date(d.criadoEm).toLocaleDateString('pt-BR')}</p>
                </div>
                <div style="text-align: right;">
                  <p style="font-size: 1.2rem; font-weight: 600; color: var(--accent);">R$ ${d.valor.toLocaleString()}</p>
                  <p style="font-size: 0.85rem; color: var(--text-secondary);">+${d.pontosConcedidos} pontos</p>
                </div>
              </div>
              ${d.mensagem ? `<p style="margin-top: 0.5rem; font-style: italic; color: var(--text-secondary);">"${d.mensagem}"</p>` : ''}
            </div>
          `).join("");
        } else {
          doacoesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma doaÃ§Ã£o realizada ainda. Comece agora.</p>';
        }

        // Carregar metas pessoais
        const metasContainer = document.getElementById("metasContainer");
        if (doador.metasPessoais && doador.metasPessoais.length > 0) {
          metasContainer.innerHTML = doador.metasPessoais.map(m => {
            const percentual = (m.arrecadado / m.valor) * 100;
            return `
              <div class="card">
                <h4>${m.nome}</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">Categoria: ${m.categoria}</p>
                <div class="progress"><div style="width: ${percentual}%;"></div></div>
                <p style="margin-top: 0.5rem; font-size: 0.9rem;">R$ ${m.arrecadado.toLocaleString()} de R$ ${m.valor.toLocaleString()}</p>
              </div>
            `;
          }).join("");
        } else {
          metasContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">Crie uma meta pessoal para acompanhar seu progresso!</p>';
        }
      } catch (error) {
        console.error("Erro ao carregar perfil:", error);
      }
    }

    // Mudar de tab
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => {
          b.style.color = "var(--text-secondary)";
          b.style.borderBottomColor = "transparent";
        });
        btn.style.color = "var(--accent)";
        btn.style.borderBottomColor = "var(--accent)";

        document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");
        document.getElementById(btn.dataset.tab).style.display = "block";
      });
    });

    async function carregarRanking() {
      const rankingContainer = document.getElementById("rankingList");
      const rankingBadge = document.getElementById("rankingPosition");
      if (!rankingContainer) return;

      rankingContainer.innerHTML = '<p class="loading-message">Carregando ranking...</p>';
      try {
        const res = await fetch("/api/ranking?limit=20");
        const lista = await res.json();
        if (!res.ok || !Array.isArray(lista) || !lista.length) {
          throw new Error("Ainda nÃ£o hÃ¡ dados suficientes");
        }

        rankingContainer.innerHTML = lista.map((item, index) => {
          const isUser = String(item._id) === String(userId);
          return `
            <div class="ranking-row ${isUser ? 'me' : ''}">
              <div>
                <span class="ranking-pos">#${index + 1}</span>
                <strong>${item.nome}</strong>
              </div>
              <div class="ranking-pontos">
                <span>${item.pontos} pts</span>
                <small>NÃ­vel ${item.nivel}</small>
              </div>
            </div>
          `;
        }).join("");

        const minhaPosicao = lista.findIndex(item => String(item._id) === String(userId));
        rankingBadge.textContent = minhaPosicao > -1 ? `Top ${minhaPosicao + 1}` : "Fora do Top 20";
      } catch (error) {
        rankingContainer.innerHTML = `<p class="loading-message">${error.message}</p>`;
        if (rankingBadge) rankingBadge.textContent = "--";
      }
    }

    carregarPerfil();
    carregarRanking();
  </script>

</body>
</html>
