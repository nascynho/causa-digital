<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💙</text></svg>">
  <script src="auth-helper.js" defer></script>
</head>
<body>
  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <button id="modoBtn" class="btn-toggle">🌙</button>
      </div>
    </div>
  </nav>
  <section class="section">
    <div class="container" style="max-width: 800px;">
      <div class="card" id="perfilInfo">
        <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
          <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem;" id="avatar">?</div>
          <div>
            <h1 style="margin: 0;" id="nomeUsuario">Carregando...</h1>
            <p style="color: var(--text-secondary); margin: 0.25rem 0 0;" id="emailUsuario">...</p>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-value" id="totalDoado">R$ 0</span>
            <span class="stat-label">Total Doado</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="pontos">0</span>
            <span class="stat-label">Pontos</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="nivel">1</span>
            <span class="stat-label">Nivel</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="doacoes">0</span>
            <span class="stat-label">Doacoes</span>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top: 1.5rem;">
        <h2 style="margin-bottom: 1rem;">🏆 Conquistas</h2>
        <div id="conquistas" class="badges-grid">
          <div class="badge-card locked">
            <span style="font-size: 2rem;">🌱</span>
            <span>Primeira Doacao</span>
          </div>
          <div class="badge-card locked">
            <span style="font-size: 2rem;">⭐</span>
            <span>5 Doacoes</span>
          </div>
          <div class="badge-card locked">
            <span style="font-size: 2rem;">💎</span>
            <span>R$ 500 doados</span>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top: 1.5rem;">
        <h2 style="margin-bottom: 1rem;">📋 Historico de Doacoes</h2>
        <div id="historico">
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Voce ainda nao fez nenhuma doacao.</p>
        </div>
      </div>
    </div>
  </section>
  <script>
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");
    if (!token || !userId) {
      window.location.href = "auth.html";
    }
    const body = document.body;
    const modoBtn = document.getElementById("modoBtn");
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      modoBtn.textContent = "☀️";
    }
    modoBtn.addEventListener("click", () => {
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      modoBtn.textContent = dark ? "☀️" : "🌙";
    });

    const mockPerfil = {
      nome: "Doador Demo",
      email: "doador@demo.com",
      pontos: 450,
      nivel: 2,
      totalDoado: 350,
      doacoes: [
        { campanha: "Cesta Basica para 100 Familias", valor: 100, data: "2025-01-15" },
        { campanha: "Material Escolar Completo", valor: 150, data: "2025-01-10" },
        { campanha: "Medicamentos Essenciais", valor: 100, data: "2025-01-05" }
      ]
    };

    async function carregarPerfil() {
      try {
        const res = await fetch(`/api/doadores/${userId}`);
        let perfil = null;
        if (res.ok) {
          perfil = await res.json();
        }
        if (!perfil) perfil = mockPerfil;
        renderPerfil(perfil);
      } catch (error) {
        renderPerfil(mockPerfil);
      }
    }

    function renderPerfil(perfil) {
      document.getElementById("avatar").textContent = perfil.nome.charAt(0).toUpperCase();
      document.getElementById("nomeUsuario").textContent = perfil.nome;
      document.getElementById("emailUsuario").textContent = perfil.email;
      document.getElementById("totalDoado").textContent = `R$ ${(perfil.totalDoado || 0).toLocaleString()}`;
      document.getElementById("pontos").textContent = (perfil.pontos || 0).toLocaleString();
      document.getElementById("nivel").textContent = perfil.nivel || 1;
      document.getElementById("doacoes").textContent = (perfil.doacoes || []).length;
      const conquistas = document.getElementById("conquistas");
      const badges = [];
      if ((perfil.doacoes || []).length >= 1) badges.push({ emoji: "🌱", nome: "Primeira Doacao" });
      if ((perfil.doacoes || []).length >= 5) badges.push({ emoji: "⭐", nome: "5 Doacoes" });
      if ((perfil.totalDoado || 0) >= 500) badges.push({ emoji: "💎", nome: "R$ 500 doados" });
      if (badges.length) {
        conquistas.innerHTML = badges.map(b => `
          <div class="badge-card">
            <span style="font-size: 2rem;">${b.emoji}</span>
            <span>${b.nome}</span>
          </div>
        `).join("");
      }
      const historico = document.getElementById("historico");
      if ((perfil.doacoes || []).length) {
        historico.innerHTML = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <th style="text-align: left; padding: 0.75rem 0;">Campanha</th>
                <th style="text-align: right; padding: 0.75rem 0;">Valor</th>
                <th style="text-align: right; padding: 0.75rem 0;">Data</th>
              </tr>
            </thead>
            <tbody>
              ${perfil.doacoes.map(d => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem 0;">${d.campanha}</td>
                  <td style="text-align: right; padding: 0.75rem 0; color: var(--success);">R$ ${d.valor.toLocaleString()}</td>
                  <td style="text-align: right; padding: 0.75rem 0; color: var(--text-secondary);">${new Date(d.data).toLocaleDateString("pt-BR")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      }
    }

    carregarPerfil();
  </script>
</body>
</html>
