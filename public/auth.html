<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrar - Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💙</text></svg>">
  <script src="auth-helper.js" defer></script>
</head>
<body>
  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <button id="modoBtn" class="btn-toggle">🌙</button>
      </div>
    </div>
  </nav>
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-tabs">
        <div class="auth-tab active" id="tabDoador">Sou Doador</div>
        <div class="auth-tab" id="tabOng">Sou ONG</div>
      </div>
      <form id="loginDoador" class="form-content">
        <h2 style="text-align: center; font-size: 1.8rem; margin-bottom: 0.5rem;">👋 Bem-vindo de volta!</h2>
        <p style="text-align: center; margin-bottom: 2rem;">Acesse sua conta e continue fazendo a diferenca.</p>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" required placeholder="seu@email.com">
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" name="senha" required minlength="6" placeholder="********">
        </div>
        <button type="submit" class="btn-primary" style="width: 100%;">Entrar como Doador</button>
        <div class="form-feedback" id="doadorFeedback"></div>
        <p style="text-align: center; margin-top: 1.5rem; font-size: 0.9rem;">
          Ainda nao tem conta? <a href="cadastro.html" style="color: var(--primary); font-weight: 600;">Cadastre-se</a>
        </p>
      </form>
      <form id="loginOng" class="form-content" style="display: none;">
        <h2 style="text-align: center; font-size: 1.8rem; margin-bottom: 0.5rem;">🏢 Portal da ONG</h2>
        <p style="text-align: center; margin-bottom: 2rem;">Gerencie suas campanhas e acompanhe o impacto em tempo real.</p>
        <div class="form-group">
          <label>Email da ONG</label>
          <input type="email" name="email" required placeholder="contato@ong.org">
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" name="senha" required minlength="6" placeholder="********">
        </div>
        <button type="submit" class="btn-primary" style="width: 100%;">Acessar Painel</button>
        <div class="form-feedback" id="ongFeedback"></div>
        <p style="text-align: center; margin-top: 1.5rem; font-size: 0.9rem;">
          Quer cadastrar sua ONG? <a href="cadastro.html" style="color: var(--primary); font-weight: 600;">Clique aqui</a>
        </p>
      </form>
    </div>
  </div>
  <script>
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");
    const ongId = localStorage.getItem("ongId");
    if (token && (userId || ongId)) {
      window.location.href = userId ? "perfil.html" : "painel.html";
    }
    const body = document.body;
    const modoBtn = document.getElementById("modoBtn");
    if (modoBtn) {
      if (localStorage.getItem("theme") === "dark") {
        body.classList.add("dark");
        modoBtn.textContent = "☀️";
      }
      modoBtn.addEventListener("click", () => {
        body.classList.toggle("dark");
        const dark = body.classList.contains("dark");
        localStorage.setItem("theme", dark ? "dark" : "light");
        modoBtn.textContent = dark ? "☀️" : "🌙";
      });
    }
    const tabDoador = document.getElementById("tabDoador");
    const tabOng = document.getElementById("tabOng");
    const formDoador = document.getElementById("loginDoador");
    const formOng = document.getElementById("loginOng");
    tabDoador.addEventListener("click", () => {
      tabDoador.classList.add("active");
      tabOng.classList.remove("active");
      formDoador.style.display = "block";
      formOng.style.display = "none";
    });
    tabOng.addEventListener("click", () => {
      tabOng.classList.add("active");
      tabDoador.classList.remove("active");
      formOng.style.display = "block";
      formDoador.style.display = "none";
    });
    function showFeedback(element, message, type = "error") {
      element.textContent = message;
      element.className = `form-feedback ${type}`;
    }
    async function handleLogin(form, endpoint, storageKeys, redirect, feedbackEl) {
      if (!form.reportValidity()) {
        showFeedback(feedbackEl, "Revise os campos destacados.");
        return;
      }
      const btn = form.querySelector("button");
      const originalText = btn.textContent;
      btn.textContent = "Validando...";
      btn.disabled = true;
      showFeedback(feedbackEl, "Conectando...", "success");
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          throw new Error("Credenciais invalidas");
        }
        const json = await res.json();
        Object.entries(storageKeys).forEach(([key, value]) => {
          localStorage.setItem(key, json[value] || value);
        });
        showFeedback(feedbackEl, "Login aprovado. Redirecionando...", "success");
        setTimeout(() => window.location.href = redirect, 400);
      } catch (error) {
        console.error(error);
        showFeedback(feedbackEl, "Nao foi possivel autenticar. Tente novamente.");
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
    formDoador.addEventListener("submit", e => {
      e.preventDefault();
      handleLogin(
        formDoador,
        "/api/auth/login/doador",
        { token: "token", userId: "userId", userType: "doador" },
        "perfil.html",
        document.getElementById("doadorFeedback")
      );
    });
    formOng.addEventListener("submit", e => {
      e.preventDefault();
      handleLogin(
        formOng,
        "/api/auth/login/ong",
        { token: "token", ongId: "ongId", userType: "ong" },
        "painel.html",
        document.getElementById("ongFeedback")
      );
    });
  </script>
</body>
</html>
