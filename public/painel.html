<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel da ONG - Causa Digital</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💙</text></svg>">
  <script src="auth-helper.js" defer></script>
</head>
<body>
  <nav>
    <div class="container nav-container">
      <a href="index.html" class="logo">Causa Digital</a>
      <div class="nav-links">
        <a href="campanhas.html">Campanhas</a>
        <a href="ongs.html">ONGs</a>
        <button id="modoBtn" class="btn-toggle">🌙</button>
      </div>
    </div>
  </nav>
  <section class="section">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
          <h1 style="margin: 0;" id="nomeOng">Painel da ONG</h1>
          <p style="color: var(--text-secondary); margin: 0.5rem 0 0;">Gerencie suas campanhas e acompanhe as doacoes</p>
        </div>
        <button class="btn-primary" id="btnNovaCampanha">+ Nova Campanha</button>
      </div>
      <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card">
          <span class="stat-value" id="totalArrecadado">R$ 0</span>
          <span class="stat-label">Total Arrecadado</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="campanhasAtivas">0</span>
          <span class="stat-label">Campanhas Ativas</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalDoadores">0</span>
          <span class="stat-label">Doadores</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalDoacoes">0</span>
          <span class="stat-label">Doacoes</span>
        </div>
      </div>
      <div class="card">
        <h2 style="margin-bottom: 1.5rem;">📋 Suas Campanhas</h2>
        <div id="listaCampanhas">
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Carregando campanhas...</p>
        </div>
      </div>
      <div class="card" style="margin-top: 1.5rem;">
        <h2 style="margin-bottom: 1.5rem;">💰 Doacoes Recentes</h2>
        <div id="listaDoacoes">
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Carregando doacoes...</p>
        </div>
      </div>
    </div>
  </section>
  <div id="modalCampanha" class="modal" style="display: none;">
    <div class="modal-content card">
      <h2 style="margin-bottom: 1.5rem;">Nova Campanha</h2>
      <form id="formCampanha">
        <div class="form-group">
          <label>Titulo da campanha</label>
          <input type="text" name="titulo" required placeholder="Ex: Cesta basica para familias">
        </div>
        <div class="form-group">
          <label>Descricao</label>
          <textarea name="descricao" rows="3" required placeholder="Descreva o objetivo da campanha"></textarea>
        </div>
        <div class="form-group">
          <label>Meta (R$)</label>
          <input type="number" name="meta" min="100" required placeholder="5000">
        </div>
        <div class="form-group">
          <label>Categoria</label>
          <select name="categoria" required>
            <option value="alimentacao">🍲 Alimentacao</option>
            <option value="educacao">📚 Educacao</option>
            <option value="saude">🏥 Saude</option>
            <option value="outros">🎮 Outros</option>
          </select>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="button" class="btn-secondary" id="btnCancelar" style="flex: 1;">Cancelar</button>
          <button type="submit" class="btn-primary" style="flex: 1;">Criar Campanha</button>
        </div>
        <p class="form-feedback" id="feedbackCampanha"></p>
      </form>
    </div>
  </div>
  <script>
    const token = localStorage.getItem("token");
    const ongId = localStorage.getItem("ongId");
    if (!token || !ongId) {
      window.location.href = "auth.html";
    }
    const body = document.body;
    const modoBtn = document.getElementById("modoBtn");
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      modoBtn.textContent = "☀️";
    }
    modoBtn.addEventListener("click", () => {
      body.classList.toggle("dark");
      const dark = body.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      modoBtn.textContent = dark ? "☀️" : "🌙";
    });

    const mockOng = {
      nome: "ONG Demo",
      totalArrecadado: 15000,
      campanhas: [
        { _id: "1", titulo: "Cesta Basica para 100 Familias", meta: 5000, arrecadado: 4500, status: "ativa" },
        { _id: "2", titulo: "Material Escolar Completo", meta: 10000, arrecadado: 8200, status: "ativa" }
      ],
      doacoes: [
        { doador: "Joao Santos", campanha: "Cesta Basica", valor: 100, data: "2025-01-15" },
        { doador: "Maria Silva", campanha: "Material Escolar", valor: 50, data: "2025-01-14" },
        { doador: "Anonimo", campanha: "Cesta Basica", valor: 200, data: "2025-01-13" }
      ]
    };

    async function carregarDados() {
      try {
        const res = await fetch(`/api/ongs/${ongId}`);
        let ong = null;
        if (res.ok) {
          ong = await res.json();
        }
        if (!ong) ong = mockOng;
        renderDados(ong);
      } catch (error) {
        renderDados(mockOng);
      }
    }

    function renderDados(ong) {
      document.getElementById("nomeOng").textContent = ong.nome;
      document.getElementById("totalArrecadado").textContent = `R$ ${(ong.totalArrecadado || 0).toLocaleString()}`;
      document.getElementById("campanhasAtivas").textContent = (ong.campanhas || []).filter(c => c.status === "ativa").length;
      document.getElementById("totalDoadores").textContent = new Set((ong.doacoes || []).map(d => d.doador)).size;
      document.getElementById("totalDoacoes").textContent = (ong.doacoes || []).length;
      const listaCampanhas = document.getElementById("listaCampanhas");
      if ((ong.campanhas || []).length) {
        listaCampanhas.innerHTML = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <th style="text-align: left; padding: 0.75rem 0;">Campanha</th>
                <th style="text-align: right; padding: 0.75rem 0;">Arrecadado</th>
                <th style="text-align: right; padding: 0.75rem 0;">Meta</th>
                <th style="text-align: center; padding: 0.75rem 0;">Status</th>
              </tr>
            </thead>
            <tbody>
              ${ong.campanhas.map(c => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem 0;">${c.titulo}</td>
                  <td style="text-align: right; padding: 0.75rem 0; color: var(--success);">R$ ${c.arrecadado.toLocaleString()}</td>
                  <td style="text-align: right; padding: 0.75rem 0;">R$ ${c.meta.toLocaleString()}</td>
                  <td style="text-align: center; padding: 0.75rem 0;"><span class="badge badge-${c.status === 'ativa' ? 'primary' : 'secondary'}">${c.status}</span></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      } else {
        listaCampanhas.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Nenhuma campanha criada ainda.</p>`;
      }
      const listaDoacoes = document.getElementById("listaDoacoes");
      if ((ong.doacoes || []).length) {
        listaDoacoes.innerHTML = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <th style="text-align: left; padding: 0.75rem 0;">Doador</th>
                <th style="text-align: left; padding: 0.75rem 0;">Campanha</th>
                <th style="text-align: right; padding: 0.75rem 0;">Valor</th>
                <th style="text-align: right; padding: 0.75rem 0;">Data</th>
              </tr>
            </thead>
            <tbody>
              ${ong.doacoes.slice(0, 10).map(d => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem 0;">${d.doador}</td>
                  <td style="padding: 0.75rem 0;">${d.campanha}</td>
                  <td style="text-align: right; padding: 0.75rem 0; color: var(--success);">R$ ${d.valor.toLocaleString()}</td>
                  <td style="text-align: right; padding: 0.75rem 0; color: var(--text-secondary);">${new Date(d.data).toLocaleDateString("pt-BR")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      } else {
        listaDoacoes.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Nenhuma doacao recebida ainda.</p>`;
      }
    }

    const modal = document.getElementById("modalCampanha");
    const btnNova = document.getElementById("btnNovaCampanha");
    const btnCancelar = document.getElementById("btnCancelar");
    const formCampanha = document.getElementById("formCampanha");
    const feedback = document.getElementById("feedbackCampanha");

    btnNova.addEventListener("click", () => modal.style.display = "flex");
    btnCancelar.addEventListener("click", () => modal.style.display = "none");
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    formCampanha.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(formCampanha).entries());
      payload.ongId = ongId;
      payload.meta = parseFloat(payload.meta);
      try {
        const res = await fetch("/api/campanhas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Erro ao criar campanha");
        feedback.textContent = "Campanha criada com sucesso!";
        feedback.style.color = "var(--success)";
        formCampanha.reset();
        setTimeout(() => {
          modal.style.display = "none";
          carregarDados();
        }, 1000);
      } catch (error) {
        feedback.textContent = "Erro ao criar campanha. Tente novamente.";
        feedback.style.color = "var(--danger)";
      }
    });

    carregarDados();
  </script>
</body>
</html>
